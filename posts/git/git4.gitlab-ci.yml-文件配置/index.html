<!DOCTYPE HTML>

<html><head>
    <title>LM</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <link rel="icon" href="/images/Infinite.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css"/>
</head><body class="is-preload" id="top">
        

        <div id="wrapper">
<header id="header">
    <h1><a href="/" style="font-size: 1.2em">LM' s Note</a></h1>
    <nav class="links">
        <ul>
            <li><a href="/posts" style="font-size: 0.9em"><strong>Posts</strong></a></li>
        </ul>
    </nav>
    <nav class="main">
        <ul>
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="#">
                    <input type="text" name="query" placeholder="施工中" disabled="disabled"/>
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>
<section id="menu">
    
    <section>
        <h2>施工中</h2>
    </section>
</section>
<div id="main">
    <header>
            <div class="title">
                <h2 style="font-size:2em"><a href="javascript:void(0)">Git(4)——.gitlab-ci.yml文件配置</a></h2>
                <p>@LM | 2021-01-13</p>
            </div>
        </header>
        <div class="content">
            <blockquote>
<p>参考原文：<a href="https://blog.51cto.com/7072753/2457095"> .gitlab-ci.yml语法  @hellojinni  </a></p>
</blockquote>
<h2 id="gitlab-ciyml-文件">.gitlab-ci.yml 文件</h2>
<p>GitLab CI 使用 YAML文件(.gitlab-ci.yml) 来管理项目配置，用来配置 CI 在你的项目中做哪些操作，这个文件位于仓库的根目录。</p>
<p>当有新内容 push 到仓库，或者有代码合并后， GitLab 会查找是否有 .gitlab-ci.yml 文件，如果文件存在， Runners 将会根据该文件的内容开始 build 本次 commit 。</p>
<p>.gitlab-ci.yml 使用 YAML 语法， 你需要格外注意缩进格式，要用空格来缩进，不能用 tabs 来缩进。</p>
<h2 id="stages">Stages</h2>
<p>Stages 表示构建阶段，说白了就是上面提到的流程。默认有3个 stages ： build , test , deploy 。我们可以在一次 Pipeline 中定义多个 Stages ，这些 Stages 会有以下特点：</p>
<ul>
<li>所有 Stages 会按照顺序运行，即当一个 Stage 完成后，下一个 Stage 才会开始</li>
<li>只有当所有 Stages 完成后，该构建任务 (Pipeline) 才会成功</li>
<li>如果任何一个 Stage 失败，那么后面的 Stages 不会执行，该构建任务 (Pipeline) 失败</li>
</ul>
<h2 id="jobs">Jobs</h2>
<p>Jobs 表示构建工作，表示某个 Stage 里面执行的工作。我们可以在 Stages 里面定义多个 Jobs ，Jobs 是由Runners接管并且由服务器中runner执行。这些 Jobs 会有以下特点：</p>
<ul>
<li>每一个 Jobs 的执行过程都是独立运行的</li>
<li>相同 Stage 中的 Jobs 会并行执行</li>
<li>相同 Stage 中的 Jobs 都执行成功时，该 Stage 才会成功</li>
<li>如果任何一个 Job 失败，那么该 Stage 失败，即该构建任务 (Pipeline) 失败</li>
</ul>
<h2 id="约束">约束</h2>
<p>YAML文件定义了一系列带有约束说明的任务。这些任务都是以任务名开始并且至少要包含script部分。</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">job1</span>:
  <span style="color:#f92672">script</span>: <span style="color:#e6db74">&#34;execute-script-for-job1&#34;</span>
  
<span style="color:#f92672">job2</span>:
  <span style="color:#f92672">script</span>: <span style="color:#e6db74">&#34;execute-script-for-job2&#34;</span>
</code></pre></div><h2 id="跳过job">跳过job</h2>
<p>如果你的 commit 信息包涵 [ci skip] 或者 [skip ci] ，不论大小写，这个 commit 将会被创建，但是 job 会被跳过</p>
<h2 id="开始">开始</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">before_script</span>:
  - <span style="color:#ae81ff">echo &#34;每个job之前都会执行&#34;</span>
</code></pre></div><h2 id="结束">结束</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">after_script</span>:
  - <span style="color:#ae81ff">echo &#34;每个job之后都会执行&#34;</span>
</code></pre></div><h2 id="示例">示例</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># 定义 stages（阶段）。任务将按此顺序执行。</span>
<span style="color:#f92672">stages</span>:
  - <span style="color:#ae81ff">build</span>
  - <span style="color:#ae81ff">test</span>
 
<span style="color:#75715e"># 定义 job（任务）</span>
<span style="color:#f92672">job1</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">test</span>
  <span style="color:#f92672">tags</span>:
    - <span style="color:#ae81ff">XX </span> <span style="color:#75715e"># 只有标签为XX的runner才会执行这个任务</span>
  <span style="color:#f92672">only</span>:
    - <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 只有dev分支提交代码才会执行这个任务。也可以是分支名称或触发器名称</span>
    - <span style="color:#ae81ff">/^future-.*$/</span> <span style="color:#75715e"># 正则表达式，只有future-开头的分支才会执行</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">echo &#34;I am job1&#34;</span>
    - <span style="color:#ae81ff">echo &#34;I am in test stage&#34;</span>
    
<span style="color:#f92672">job2</span>:
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">test</span> <span style="color:#75715e"># 如果此处没有定义stage，其默认也是test</span>
  <span style="color:#f92672">only</span>:
    - <span style="color:#ae81ff">master</span> <span style="color:#75715e"># 只有master分支提交代码才会执行这个任务</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">echo &#34;I am job2&#34;</span>
    - <span style="color:#ae81ff">echo &#34;I am in test stage&#34;</span>
  <span style="color:#f92672">allow_failure</span>: <span style="color:#66d9ef">true</span> <span style="color:#75715e"># 允许失败，即不影响下步构建</span>

<span style="color:#f92672">.job3</span>:
<span style="color:#75715e"># 对于临时不想执行的job，可以选择在前面加个&#34;.&#34;，这样就会跳过此步任务，否则你除了要注释掉这个job3外，还需要注释上面为build的stage</span>
  <span style="color:#f92672">stage</span>: <span style="color:#ae81ff">build</span>
  <span style="color:#f92672">except</span>:
    - <span style="color:#ae81ff">dev</span> <span style="color:#75715e"># 除了dev分支，其它分支提交代码都会执行这个任务</span>
  <span style="color:#f92672">script</span>:
    - <span style="color:#ae81ff">echo &#34;I am job3&#34;</span>
    - <span style="color:#ae81ff">echo &#34;I am in build stage&#34;</span>
    
<span style="color:#75715e"># 下面几个都相当于全局变量</span>
<span style="color:#f92672">before_script</span>:
  - <span style="color:#ae81ff">echo &#34;每个job之前都会执行&#34;</span>
  - <span style="color:#ae81ff">export MVN_HOME</span>
  - <span style="color:#ae81ff">export JAVA_HOME</span>
  - <span style="color:#ae81ff">java -version</span>
  - <span style="color:#ae81ff">sh /home/gitlab-runner/kill.sh</span>

<span style="color:#f92672">after_script</span>:
  - <span style="color:#ae81ff">echo &#34;每个job之后都会执行&#34;</span>
  
<span style="color:#f92672">variables</span>: 
<span style="color:#75715e"># 变量</span>
  <span style="color:#f92672">DATABASE_URL</span>: <span style="color:#e6db74">&#34;postgres://postgres@postgres/my_database&#34;</span> 
  <span style="color:#75715e"># 在job中可以用${DATABASE_URL}来使用这个变量。常用的预定义变量有CI_COMMIT_REF_NAME（项目所在的分支或标签名称），CI_JOB_NAME（任务名称），CI_JOB_STAGE（任务阶段）</span>

  <span style="color:#f92672">GIT_STRATEGY</span>: <span style="color:#e6db74">&#34;none&#34;</span> 
  <span style="color:#75715e"># GIT策略，定义拉取代码的方式，有3种：clone/fetch/none，默认为clone，速度最慢，每步job都会重新clone一次代码。我们一般将它设置为none，在具体任务里设置为fetch就可以满足需求，毕竟不是每步都需要新代码，那也不符合我们测试的流程</span>
  
<span style="color:#f92672">cache</span>: 
<span style="color:#75715e"># 缓存</span>
<span style="color:#75715e">#因为缓存为不同管道和任务间共享，可能会覆盖，所以有时需要设置key</span>
  <span style="color:#f92672">key</span>: <span style="color:#ae81ff">${CI_COMMIT_REF_NAME} </span>
  <span style="color:#75715e"># 启用每分支缓存。</span>
  <span style="color:#75715e"># key: &#34;$CI_JOB_NAME/$CI_COMMIT_REF_NAME&#34; # 启用每个任务和每个分支缓存。需要注意的是，如果是在windows中运行这个脚本，需要把$换成%</span>

  <span style="color:#f92672">untracked</span>: <span style="color:#66d9ef">true</span> 
  <span style="color:#75715e"># 缓存所有Git未跟踪的文件</span>

  <span style="color:#f92672">paths</span>: 
  <span style="color:#75715e"># 以下2个文件夹会被缓存起来，下次构建会解压出来</span>
    - <span style="color:#ae81ff">node_modules/</span>
    - <span style="color:#ae81ff">dist/</span>
    
</code></pre></div><h2 id="保留字段">保留字段</h2>
<p>这些保留字段不能被定义为job名称</p>
<ul>
<li><strong>image和services</strong>：这两个关键字允许使用一个自定义的Docker镜像和一系列的服务，并且可以用于整个job周期</li>
<li><strong>before_script</strong>：before_script 用来定义所有job之前运行的命令</li>
<li><strong>after_script</strong>：after_script用来定义所有job之后运行的命令</li>
<li><strong>stages</strong>：stages用来定义可以被job调用的stages。stages的规范允许有灵活的多级pipelines。stages中的元素顺序决定了对应job的执行顺序</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#75715e"># 相同stage的job可以平行执行。</span>
<span style="color:#75715e"># 下一个stage的job会在前一个stage的job成功后开始执行。</span>
<span style="color:#75715e"># 如果.gitlab-ci.yml中没有定义stages，那么job&#39;s stages 会默认定义为 build，test 和 deploy。</span>
<span style="color:#75715e"># 如果一个job没有指定stage，那么这个任务会分配到test stage。</span>
</code></pre></div><ul>
<li><strong>types</strong>：与stages同义</li>
<li><strong>variables</strong>：变量</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">variables</span>:
  <span style="color:#ae81ff">DATABASE_URL:&#34;postgres://postgres@postgres/my_database&#34;</span>
</code></pre></div><ul>
<li><strong>cache</strong>：用来指定需要在job之间缓存的文件或目录。只能使用该项目工作空间内的路径。</li>
<li><strong>Jobs</strong>：工作</li>
<li><strong>script</strong>：脚本</li>
</ul>
<h2 id="only-and-except">only and except</h2>
<p>only和except是两个参数用分支策略来限制jobs构建：</p>
<ul>
<li>only定义哪些分支和标签的git项目将会被job执行。</li>
<li>except定义哪些分支和标签的git项目将不会被job执行。</li>
</ul>
<p>下面是refs策略的使用规则：</p>
<ul>
<li>only和except可同时使用。如果only和except在一个job配置中同时存在，则以only为准，跳过except(从下面示例中得出)。</li>
<li>only和except可以使用正则表达式。</li>
<li>only和except允许使用特殊的关键字：branches，tags和triggers。</li>
<li>only和except允许使用指定仓库地址但不是forks的仓库。</li>
</ul>
<h2 id="tags">tags</h2>
<p>tags可以从允许运行此项目的所有Runners中选择特定的Runners来执行jobs。</p>
<p>在注册Runner的过程中，我们可以设置Runner的标签，比如ruby，postgres，development。</p>
<p>tags可通过tags来指定特殊的Runners来运行jobs。</p>
<h2 id="allow_failure">allow_failure</h2>
<p>allow_failure可以用于当你想设置一个job失败的之后并不影响后续的CI组件的时候。失败的jobs不会影响到commit状态。</p>
<p>当开启了允许job失败，所有的intents和purposes里的pipeline都是成功/绿色，但是也会有一个&quot;CI build passed with warnings&quot;信息显示在merge request或commit或job page。这被允许失败的作业使用，但是如果失败表示其他地方应采取其他（手动）步骤。</p>
<h2 id="when">when</h2>
<p>when is used to implement jobs that are run in case of failure or despite the failure.</p>
<p>when可以设置以下值：</p>
<ul>
<li>on_success - 只有前面stages的所有工作成功时才执行。 这是默认值。</li>
<li>on_failure - 当前面stages中任意一个jobs失败后执行。</li>
<li>always - 无论前面stages中jobs状态如何都执行。</li>
<li>manual- 手动执行(GitLab8.10增加)。更多请查看手动操作。</li>
</ul>
<h2 id="manual-actions">Manual actions</h2>
<p>手动操作指令是不自动执行的特殊类型的job；它们必须要人为启动。手动操作指令可以从pipeline，build，environment和deployment视图中启动。</p>

            <p style="margin-top:1em;"></p>
        </div>
        <footer>
            <p class="post-copyright-license" style="margin-top:1em; margin-bottom:1em">
                <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                                                            rel="noopener" target="_blank"><i
                    class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。
            </p>
        </footer>
    
    <ul class="actions pagination" style="margin-bottom:5px; float:right">
        <li><a href="#top" class="button large">回到顶部</a></li>
        
          <li><a href="https://ac-lm.github.io/posts/git/git2ssh-%E9%85%8D%E7%BD%AE/" class="button large previous">上一页</a></li>
        
        
    </ul>
</div>


        </div>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/browser.min.js"></script>
<script src="/assets/js/breakpoints.min.js"></script>
<script src="/assets/js/util.js"></script>
<script src="/assets/js/main.js"></script></body>
</html>
