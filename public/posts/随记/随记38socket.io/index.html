<!DOCTYPE HTML>

<html><head>
    <title>LM</title>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <link rel="icon" href="/images/Infinite.png" type="image/x-icon">
    <link rel="stylesheet" href="/assets/css/main.css"/>
</head><body class="is-preload" id="top">
        

        <div id="wrapper">
<header id="header">
    <h1><a href="/" style="font-size: 1.2em">LM' s Note</a></h1>
    <nav class="links">
        <ul>
            <li><a href="/posts" style="font-size: 0.9em"><strong>Posts</strong></a></li>
        </ul>
    </nav>
    <nav class="main">
        <ul>
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" action="/404.html">
                    <input type="text" name="query" placeholder="请输入关键字"/>
                </form>
            </li>
            
        </ul>
    </nav>
</header>
            
<div id="main">
    <header>
            <div class="title">
                <h2 style="font-size:2em"><a href="javascript:void(0)">随记(38)——Socket.IO</a></h2>
                <p>@LM | 2021-11-23</p>
            </div>
        </header>
        <div class="content">
            <blockquote>
<p><a href="https://socket.io/docs/v4/how-it-works/"> Introduction @Socket.IO </a></p>
</blockquote>
<h2 id="1工作原理">1.工作原理</h2>
<p>Socket.IO 是 Websocket 的一个实现，其分为服务器（node.js）和客户端（浏览器、node.js或其他编程语言）。服务器与客户端之间的双向通道使用 Websocket 连接建立，并使用 HTTP 长轮询作为回退。</p>
<p>Socket.IO 代码库分为两个不同的层：</p>
<ul>
<li>低级管道：我们称之为 Engine.IO，作为 Socket.IO 的内部发动机</li>
<li>高级别 API： Socket.IO 本身</li>
</ul>
<h2 id="2engineio">2.Engine.IO</h2>
<p>Engine.IO 负责建立服务器和客户端之间的低级连接。它处理：</p>
<ul>
<li>各种数据运输和升级机制</li>
<li>断开检测</li>
</ul>
<h3 id="a运输">a.运输</h3>
<p>目前有两个已实现的运输：</p>
<ul>
<li>HTTP 长轮询</li>
<li>Websocket</li>
</ul>
<h3 id="b握手">b.握手</h3>
<p>在 Engine.IO 连接的开始，服务器会发送一些信息：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{  
    <span style="color:#f92672">&#34;sid&#34;</span>: <span style="color:#e6db74">&#34;FSDjX-WRwSA4zTZMALqx&#34;</span>,  
    <span style="color:#f92672">&#34;upgrades&#34;</span>: [<span style="color:#e6db74">&#34;websocket&#34;</span>],  
    <span style="color:#f92672">&#34;pingInterval&#34;</span>: <span style="color:#ae81ff">25000</span>,  
    <span style="color:#f92672">&#34;pingTimeout&#34;</span>: <span style="color:#ae81ff">20000</span>
}
</code></pre></div><ul>
<li><code>sid</code> 是会话的 ID，它必须包含在所有后续 HTTP 请求中的查询参数中</li>
<li><code>upgrades</code> 包含由服务器支持的所有链接列表</li>
<li><code>pingInterval</code> 与 <code>pingTimeout</code> 的值用于心跳机制，以检查连接状态</li>
</ul>
<h3 id="c升级机制">c.升级机制</h3>
<p>默认情况下，客户端会先与 HTTP 长轮询传输建立连接。</p>
<p>虽然 Websocket 是建立双向通信的最佳方式，但经验表明，由于代理、防火墙、防病毒软件等原因，建立 Websocket 连接并不总是可能的。从用户的角度来看，不成功的 Websocket 连接会伤害用户体验。</p>
<p>综上所及，Engine.IO 首先关注可靠性和用户体验，其次再改进和提高服务器性能。</p>
<p>Engine.IO 可以将 HTTP 长轮询升级为 Websocket，升级时，客户端将：</p>
<ul>
<li>确保其传出缓冲器是空的</li>
<li>将当前传输置于仅读模式</li>
<li>尝试与其他运输建立连接</li>
<li>如果成功，关闭第一次运输</li>
</ul>
<p>您可以查看浏览器的网络监视器：</p>
<p><img src="https://gitee.com/LM-J/drawingbed/raw/master/img/20211124171855.png" alt=""></p>
<ol>
<li>握手 （包含会话 ID <code>sid = zBjrh...AAAK</code> 在此处 ，在随后的请求中使用）</li>
<li>发送数据（HTTP 长轮询）</li>
<li>接收数据（HTTP 长轮询）</li>
<li>升级（Websocket）</li>
<li>接收数据（HTTP 长轮询会在成功建立 Websocket 连接后关闭）</li>
</ol>
<h3 id="d断开检测">d.断开检测</h3>
<p>Engine.IO 连接会在下列情况中视为关闭：</p>
<ul>
<li>一个 HTTP 请求（GET 或 POST）失败</li>
<li>网络插座连接已关闭（例如，当用户关闭浏览器中的选项卡时）</li>
<li><code>socket.disconnect()</code>在服务器端或客户端调用</li>
</ul>
<p>还有一个心跳机制，检查服务器和客户端之间的连接是否仍然启动和运行：</p>
<p>在给定间隔，服务器发送 PING 数据包，客户端将 PONG 数据包发回。如果服务器没有收到 PONG 数据包，它将认为连接已关闭。相反，如果客户端内部未收到 PING 数据包，则会认为连接已关闭。</p>

            <p style="margin-top:1em;"></p>
        </div>
        <footer>
            <p class="post-copyright-license" style="margin-top:1em; margin-bottom:1em">
                <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/"
                                                            rel="noopener" target="_blank"><i
                    class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。
            </p>
        </footer>
    
    <ul class="actions pagination" style="margin-bottom:5px; float:right">
        <li><a href="#top" class="button large">回到顶部</a></li>
        
          <li><a href="https://ac-lm.github.io/posts/%E9%9A%8F%E8%AE%B0/%E9%9A%8F%E8%AE%B037websocket/" class="button large previous">上一页</a></li>
        
        
    </ul>
</div>


        </div>
<script src="/assets/js/jquery.min.js"></script>
<script src="/assets/js/browser.min.js"></script>
<script src="/assets/js/breakpoints.min.js"></script>
<script src="/assets/js/util.js"></script>
<script src="/assets/js/main.js"></script></body>
</html>
